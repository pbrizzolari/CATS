# Author: Nadine Slingerland
# Date: 04/04/2021

#Load file
setwd("~/VU - Master Oncology/Course 9. Bioinformatics in Translational Medicine/CATS")

# Install packages
install.packages('caret', dependencies=TRUE)
install.packages("dplyr")

library(caret)
library(dplyr)

# Import file
Train <- read.delim('Train_Call.txt', header = TRUE, sep = "\t", quote = "\"", dec = ".")
Train1 <- as.data.frame(t(Train))
Label <- read.delim('Train_Clinical.txt', header = TRUE, sep = "\t", quote = "\"", dec = ".")
row.names(Label) <- Label$Sample

info <- paste(Train$Chromosome, Train$Start, Train$End, Train$Nclone, sep = "_")
colnames(Train1) <- info

merged <- merge(Label, Train1, by="row.names", all = TRUE)
row.names(merged) <- merged$Row.names
merged$Row.names <- NULL

merged <- merged[complete.cases(merged),]
merged <- merged[-c(1)]


# Investigate data
count(merged, Subgroup)

merged$Subgroup <- as.factor(merged$Subgroup)

set.seed(123)
indxTrain <- createDataPartition(y = merged$`Subgroup`, p = 0.80,list = FALSE)
training <- merged[indxTrain,]
testing <- merged[-indxTrain,]
prop.table(table(training$`Subgroup`)) * 100

trainX <- training[,names(training) != "Subgroup"]
preProcValues <- preProcess(x = trainX, method = c("center", "scale"))
preProcValues

set.seed(400)
trctrl <- trainControl(method="repeatedcv", number = 10, repeats = 10) 
knnFit <- train(Subgroup ~ ., data = training, method = "knn", trControl = trctrl, preProcess = NULL , tuneLength = 20)

knnFit

plot(knnFit)

knnPredict <- predict(knnFit,newdata = testing )

confusionMatrix(knnPredict, testing$Subgroup )

mean(knnPredict == testing$Subgroup)

ctrl <- trainControl(method="repeatedcv",number = 10, repeats = 10, classProbs=TRUE, summaryFunction = twoClassSummary)
knnFit <- train(Subgroup ~ ., data = training, method = "knn", trControl = ctrl, preProcess = NULL, tuneLength = 20)
knnFit



ind = sample(2, nrow(merged), replace = TRUE, prob=c(0.8,0.2))
train.df = merged[ind == 1,]
test.df = merged[ind == 2,]
dim(train.df)
dim(test.df)

table(train.df$Type)

table(test.df$Type)

trctrl <- trainControl(method = "repeatedcv", number = 10, repeats = 10)

knn_fit <- train(Subgroup ~., data = train.df, method = "knn",
                 trControl=trctrl,
                 preProcess = NULL,
                 tuneLength = 15)

knn_fit

plot(knn_fit)

test_pred <- predict(knn_fit, newdata = test.df)
test_pred

confusionMatrix(test_pred, test.df$Type )


mean(test_pred == test.df$Type)

